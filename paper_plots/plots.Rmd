---
title: "HRApop Plots Notebook"
output:
  html_document:
    df_print: paged
---

# Environment

```{r message=FALSE, warning=FALSE}

#libraries
library(tidyverse)
library(scales) #for scatter graph and bar graph
library(ggrepel) # to jitter labels
library(networkD3) #for Sankey
library(RColorBrewer) # for plots
library(ggcorrplot) # for tissue block similarity matrix
library(lsa) # for tissue block similarity matrix
library(rmarkdown) # for rendering this

#load themes
source("scripts/themes.R")

# global variables
hra_pop_version = "0.10.2"
```

# Supplemental Fig. Sankey
We will use `networkD3` to render the Sankey diagram. On the data side, we need two tibbles:\
- NODES with NodeId\
- LINKS with Source, Target, Value

## Load Data

```{r message=FALSE, warning=FALSE}
table_s1 = read_csv(paste("../../hra-pop/output-data/v",hra_pop_version,"/reports/atlas/table-s1.csv", sep = ""))
```

## Create bins for donor age and BMI

### Define function to create bins
```{r}
add_bin = function(original_column, bins, labels){
  # Create new column with bins
  result <- cut(original_column, breaks = bins, labels = labels, include.lowest = TRUE)
  
  return(as.character(result))
}
```

### Add bins
```{r message=FALSE}

# create new tibble
table_s1_with_bins = table_s1 

# Create bins and labels
bins_age = c(0, 18, 35, 50, 65, 85, 120)  # Define bin edges
labels_age = c("Underage", "Young adult", "Adult", "Middle", "Senior", "Very senior") 

bins_bmi = c(0,18.5, 24.9, 29.9, 60.0)
labels_bmi = c("underweight", "healthy", "overweight", "obese")

bins_cells_total = c(0,10000, 20000,35000,280000)
labels_cells_total=c("<10,000", "10,000-20,000", "20,000-35,000", ">35,000")

bins_volume_per_tb_bins = c(0,1000,2000,4000,8000,10000)
labels_volume_per_tb = c("<1,000","1,000-2,000","2,000-4,000","4,000",">8,000")

bins_cell_types = c(0,25, 50, 75, 100, 125, 150)
labels_cell_types = c("<25", "25-50", "50-75", "75-100", "100-125", "125-150")

table_s1_with_bins$donor_age_binned = add_bin(table_s1_with_bins$donor_age, bins_age, labels_age)
table_s1_with_bins$donor_bmi_binned = add_bin(table_s1_with_bins$donor_bmi, bins_bmi, labels_bmi)
table_s1_with_bins$cells_total_binned = add_bin(table_s1_with_bins$number_of_cells_total, bins_cells_total, labels_cells_total)
table_s1_with_bins$volume_binned = add_bin(table_s1_with_bins$tissue_block_volume, bins_volume_per_tb_bins, labels_volume_per_tb)
table_s1_with_bins$cell_types_binned = add_bin(table_s1$number_of_unique_cell_types, bins_cell_types, labels_cell_types)
```

## Create subset
```{r}
subset_sankey = table_s1_with_bins %>% 
  select(portal, donor_sex, organ_name, cell_type_annotation_tool, donor_race, donor_bmi_binned, donor_age_binned, cells_total_binned, volume_binned, cell_types_binned) %>% 
  
  # replace NAs
  replace_na(list(donor_sex = "Unknown Sex")) %>% 
  replace_na(list(donor_race = "Unknown Race")) %>% 
  
  # replace NAs for binned variables
  replace_na(list(donor_bmi_binned = "Unknown BMI")) %>%
  replace_na(list(donor_age_binned = "Unknown Age")) %>%
  # unify left and right kidney
  mutate(organ_name = ifelse(organ_name == "left kidney" | organ_name == "right kidney", "kidney", organ_name))
```

## Create nodes
```{r}
p = subset_sankey %>% 
  group_by(portal) %>% summarize()

d = subset_sankey %>% 
  group_by(donor_sex) %>% summarize()

a = subset_sankey %>% 
  group_by(donor_age_binned) %>% summarize()

b = subset_sankey %>%
  group_by(donor_bmi_binned) %>% summarize()

r = subset_sankey %>% 
  group_by(donor_race) %>% summarize()

o = subset_sankey %>% 
  group_by(organ_name) %>% summarize()

v = subset_sankey %>% 
  group_by(volume_binned) %>% summarize()

c = subset_sankey %>% 
  group_by(cell_type_annotation_tool) %>% summarize()

ce = subset_sankey %>% 
  group_by(cells_total_binned) %>% summarize()

ct = subset_sankey %>% 
  group_by(cell_types_binned) %>% summarize()

unique_name=list()
unique_name = unlist(append(unique_name, c(p, d, a, b, r, o, v, c, ce, ct)))
unique_name = list(unique_name)

nodes = as.data.frame(tibble(name = character()))
```

## Create links
```{r}
for(u in unique_name){
  nodes = nodes %>% 
    add_row(name=u)
}

nodes$index <- 1:nrow (nodes) 
nodes

nodes$index = nodes$index-1
nodes

s_o = subset_sankey %>% 
  group_by(portal, donor_sex) %>% 
  summarize(count=n()) %>% 
  rename(
    source = portal,
    target = donor_sex,
    value=count
  )

r_o = subset_sankey %>% 
  group_by(donor_sex, donor_race) %>% 
  summarize(count=n()) %>% 
  rename(
    source = donor_sex,
    target = donor_race,
    value=count
  )

a_o = subset_sankey %>% 
  group_by(donor_race, donor_age_binned) %>% 
  summarize(count=n()) %>% 
  rename(
    source = donor_race,
    target = donor_age_binned,
    value=count
  )

d_o = subset_sankey %>% 
  group_by(donor_age_binned, organ_name) %>% 
  summarize(count=n()) %>% 
  rename(
    source = donor_age_binned,
    target = organ_name,
    value=count
  )

v_o = subset_sankey %>%
  group_by(organ_name, volume_binned) %>%
  summarize(count=n()) %>%
  rename(
    source = organ_name,
    target = volume_binned,
    value=count
  )

b_o = subset_sankey %>%
  group_by(volume_binned, donor_bmi_binned) %>%
  summarize(count=n()) %>%
  rename(
    source = volume_binned,
    target = donor_bmi_binned,
    value=count
  )

c_o = subset_sankey %>% 
  group_by(donor_bmi_binned, cell_type_annotation_tool) %>% 
  summarize(count=n()) %>% 
  rename(
    source = donor_bmi_binned,
    target = cell_type_annotation_tool,
    value=count
  )

ce_o = subset_sankey %>% 
  group_by(cell_type_annotation_tool, cells_total_binned) %>% 
  summarize(count=n()) %>% 
  rename(
    source = cell_type_annotation_tool,
    target = cells_total_binned,
    value=count
  )

ct_o = subset_sankey %>% 
  group_by(cells_total_binned, cell_types_binned) %>% 
  summarize(count=n()) %>% 
  rename(
    source = cells_total_binned,
    target = cell_types_binned,
    value=count
  )

prep_links = as.data.frame(bind_rows(s_o, r_o, a_o, d_o, v_o, b_o, c_o, ce_o, ct_o))
prep_links 

links = prep_links 
```

## Rename node and link tables
```{r}
names(nodes)[1] = "source"
prep_links = left_join(prep_links, nodes,by="source")

names(nodes)[1] = "target"
prep_links = left_join(prep_links, nodes,by="target")
prep_links

prep_links = prep_links[,c(4,5,3)]
names(prep_links)[1:2] = c("source", "target")
names(nodes)[1] = "name"
```

## Draw the Sankey diagram

```{r}
# draw Sankey diagram
p <- sankeyNetwork(Links = prep_links, Nodes = nodes, Source = "source",
                   Target = "target", Value = "value", NodeID = "name", 
                   # colourScale = my_color,
                   units = "occurrences", fontSize = 15, nodeWidth = 30, width=1100)

p
```

## Export the Sankey diagram as HTML

```{r}
saveNetwork(p, "../docs/sankey.html")
```
