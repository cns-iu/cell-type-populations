---
title: "Anatomical Structures & Cell Type Population - Stacked Bar Graphs - Notebook"
output: html_notebook
---

### Environment 

```{r environment, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyr)
library(plyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(stringr)

options(scipen = 999)
```

### Load Data

```{r load, echo=TRUE}
# Data - bar graph 
# Includes organ, anatomical structure, cell types measures by tool and donor gender
df <- read.csv("https://raw.githubusercontent.com/x-atlas-consortia/hra-pop/main/output-data/v0.10.2/reports/atlas/validation-v6.csv", 
                 header=T, fileEncoding = "UTF8")

# Cell Type Crosswalks - Data Cleaning
# https://github.com/hubmapconsortium/hra-workflows-runner/tree/main/crosswalking-tables
# New version June 2024
## Azimuth
azimuth <- read.csv("https://raw.githubusercontent.com/hubmapconsortium/hra-workflows-runner/main/crosswalking-tables/azimuth.csv",
                header=T, fileEncoding = "UTF8", skip=10)

## Cell Typist
celltypist <- read.csv("https://raw.githubusercontent.com/hubmapconsortium/hra-workflows-runner/main/crosswalking-tables/celltypist.csv",
                header=T, fileEncoding = "UTF8", skip=10)

## PopV
popv <- read.csv("https://raw.githubusercontent.com/hubmapconsortium/hra-workflows-runner/main/crosswalking-tables/popv.csv",
                header=T, fileEncoding = "UTF8", skip=10)
```

### Preparing Data

```{r prep, echo=TRUE}
# Prepare crosswalk field names
names(celltypist) <- names(popv) <- names(azimuth) <- c("organ_level","organ_id",
                                                        "annotation_label","annotation_label_id",
                                                        "cell_label","cell_id","cell_match")

# Title Case for Annotation Labels
popv$annotation_label <- str_to_title(popv$annotation_label)
azimuth$annotation_label <- str_to_title(azimuth$annotation_label)
celltypist$annotation_label <- str_to_title(celltypist$annotation_label)

# Add record number to data 
df$rec <- as.numeric(row.names(df))

# Prepare Sex
df$sex <- factor(df$sex)

# Prepare Tool
df$tool <- factor(df$tool, 
                  levels=c("azimuth","celltypist","popv","sc_proteomics"),
                  labels=c("Azimuth","CellTypist","popV","SC Proteomics"))

# Prepare organ labels
df$organ <- df$organ %>% 
  str_replace("left ", "") %>%
  str_replace("right ", "") %>%
  str_replace("Set of ", "") %>%
  str_replace("left ", "") %>%
  str_replace(" of body", "") %>% 
  str_replace("respiratory system","lung") %>%
  str_replace("male reproductive system","prostate") %>%
  str_to_title()
df$organ <- factor(df$organ)

# Prepare anatomical structure labels
df$as <- df$as %>% 
  str_to_title() %>%
  str_replace(" Part "," part ") %>%
  str_replace(" Of "," of ") %>% 
  str_replace(" In "," in ") %>%
  str_replace("Heart ","")

df$cell_label <- df$cell_label %>%
  str_replace("_"," ")

# Common labels for data frames.
labels <-  c("sex", "tool", "modality", "organ", "organId", 
             "as", "as_id",  "cell_id", "cell_label", "cell_count",
             "percentage", "asct_relation_in_asctb_table",
             "indirect_asct_relation_in_asctb_table", 
             "annotation_label", "annotation_label_id", "cell_label2")

# Identify the unique set of cell ids and cell labels
cell_ids_unique <- 
  unique(df[,c(8,9)]) %>%
  arrange(cell_id)

cell_ids_count <-
  cell_ids_unique %>%
  ddply(.(cell_id), summarise,
        count = length(cell_label))

cell_ids_unique <- 
  right_join(cell_ids_unique,cell_ids_count, by="cell_id") %>%
  arrange(desc(count), cell_id)

# Export results
write.csv(cell_ids_unique, file=paste0("../bargraphs/HRApop_AS-CTBarGraph-cellID_cellLabels.csv"),
          row.names = FALSE)
write.csv(cell_ids_count, file=paste0("../bargraphs/HRApop_AS-CTBarGraph-cellID_countLabels.csv"),
          row.names = FALSE)

rm(cell_ids_unique, cell_ids_count)
```

#### Clean up Cell Labeling

```{r cell_labs}
# Creating Organ Subset for Cell Label clean-up
# Heart - 1086 records
heart <- df[df$organ==levels(df$organ)[1],]
tmp1 <- join(heart[heart$tool=="Azimuth",c(1:13)],
             azimuth[azimuth$organ_level=="Heart_L2" &
                     azimuth$cell_match=="skos:exactMatch", c(3:6)], 
             by="cell_id", type="left")
tmp2 <- join(heart[heart$tool=="popV",c(1:13)],
             popv[popv$organ_level=="heart" &
                 popv$cell_match=="skos:exactMatch", c(3:6)], 
             by="cell_id", type="left") 
tmp3 <- join(heart[heart$tool=="CellTypist",c(1:13)],
             celltypist[celltypist$organ_level=="Healthy_Adult_Heart_pkl" &
                        celltypist$cell_match=="skos:exactMatch", c(3:6)], 
             by="cell_id", type="left")
names(tmp1) <- names(tmp2) <- names(tmp3) <- labels
heart_annotation <- heart <- rbind(tmp1,tmp2,tmp3) 
heart[is.na(heart$annotation_label),]$annotation_label <- 
  heart[is.na(heart$annotation_label),]$cell_label

# Lung - 826 records
lung <- df[df$organ==levels(df$organ)[6],]
tmp1 <- join(lung[lung$tool=="Azimuth",c(1:13)],
             azimuth[azimuth$organ_level=="Lung_v2_L5" &
                     azimuth$cell_match=="skos:exactMatch", c(3:6)],
             by="cell_id", type="left")
tmp2 <- join(lung[lung$tool=="popV",c(1:13)],
             popv[popv$organ_level=="lung" &
                  popv$cell_match=="skos:exactMatch", c(3:6)],
             by="cell_id", type="left")
tmp3 <- join(lung[lung$tool=="CellTypist",c(1:13)],
             celltypist[celltypist$organ_level=="Human_Lung_Atlas_pkl" &
                        celltypist$cell_match=="skos:exactMatch", c(3:6)],
             by="cell_id", type="left")
names(tmp1) <- names(tmp2) <- names(tmp3) <- labels
lung_annotation <- lung <- rbind(tmp1,tmp2,tmp3)
lung[is.na(lung$annotation_label),]$annotation_label <-
  lung[is.na(lung$annotation_label),]$cell_label


# Kidney - 898 records
kidney <- df[df$organ==levels(df$organ)[2],]
kidney <- join(kidney[kidney$tool=="Azimuth",c(1:13)],
             azimuth[azimuth$organ_level=="Kidney_L3" &
                     azimuth$cell_match=="skos:exactMatch", c(3:6)],
             by="cell_id", type="left")
names(kidney) <- labels
kidney_annotation <- kidney
kidney[is.na(kidney$annotation_label),]$annotation_label <-
  kidney[is.na(kidney$annotation_label),]$cell_label

# Large Intestine - 1714 records
largeIntestine <- df[df$organ==levels(df$organ)[4],]
tmp1 <- largeIntestine[largeIntestine$tool=="SC Proteomics",c(1:13)] %>%
          mutate(annotation_label = cell_label,
                 annotation_label_id = cell_id)
tmp1 <- tmp1[,c(1:15,8)]
tmp2 <- join(largeIntestine[largeIntestine$tool=="popV",c(1:13)],
             popv[popv$organ_level=="large intestine" &
                  popv$cell_match=="skos:exactMatch", c(3:6)], 
             by="cell_id", type="left") 
tmp3 <- join(largeIntestine[largeIntestine$tool=="CellTypist",c(1:13)],
             celltypist[celltypist$organ_level=="intestine_L1" &
                        celltypist$cell_match=="skos:exactMatch", c(3:6)], 
             by="cell_id", type="left")
names(tmp1) <- names(tmp2) <- names(tmp3) <- labels
largeIntestine_annotation <- largeIntestine <- rbind(tmp1,tmp2,tmp3)
largeIntestine[is.na(largeIntestine$annotation_label),]$annotation_label <-
  largeIntestine[is.na(largeIntestine$annotation_label),]$cell_label

# Small Intestine - 2012 records
smallIntestine <- df[df$organ==levels(df$organ)[9],] 
tmp1 <- smallIntestine[smallIntestine$tool=="SC Proteomics",c(1:13)] %>%
          mutate(annotation_label = cell_label,
                 annotation_label_id = cell_id)
tmp1 <- tmp1[,c(1:15,9)]
tmp2 <- join(smallIntestine[smallIntestine$tool=="popV",c(1:13)],
             popv[popv$organ_level=="small intestine" &
                  popv$cell_match=="skos:exactMatch", c(3:6)], 
             by="cell_id", type="left") 
tmp3 <- join(smallIntestine[smallIntestine$tool=="CellTypist",c(1:13)],
             celltypist[celltypist$organ_level=="intestine_L1" &
                       celltypist$cell_match=="skos:exactMatch", c(3:6)], 
             by="cell_id", type="left")
names(tmp1) <- names(tmp2) <- names(tmp3) <- labels
smallIntestine_annotation <- smallIntestine <- rbind(tmp1,tmp2,tmp3) 
smallIntestine[is.na(smallIntestine$annotation_label),]$annotation_label <-
  smallIntestine[is.na(smallIntestine$annotation_label),]$cell_label

# Clean up
rm(tmp1,tmp2,tmp3)

# Data with clean cell labels for pivots
df2 <- 
  rbind(heart, lung, kidney, largeIntestine, smallIntestine) %>%
  select(tool, modality, sex, organ, organId, as, as_id, cell_id, cell_label, 
         annotation_label, cell_count, percentage, 
         asct_relation_in_asctb_table, 
         indirect_asct_relation_in_asctb_table)

rm(heart, lung, kidney, largeIntestine, smallIntestine) 

# Cell Type annotation look-up, without back-filled cell_labels and cell_ids.
# Not all data but for major organs.
organ_celltype_annotations <-  
  rbind(heart_annotation, lung_annotation, kidney_annotation, 
        largeIntestine_annotation, smallIntestine_annotation) %>%
  select(tool, modality, sex, organ, organId, as, as_id, cell_id, cell_label, 
         annotation_label_id, annotation_label, cell_count, percentage, 
         asct_relation_in_asctb_table, indirect_asct_relation_in_asctb_table)

write.csv(organ_celltype_annotations,
          file=paste0("../bargraphs/HRApop_AS-CTBarGraph-cellID_annotationIDs.csv"),
          row.names = FALSE)

rm(organ_celltype_annotations,heart_annotation, lung_annotation,
   kidney_annotation, largeIntestine_annotation, smallIntestine_annotation)

# # Cell label corrections
# df2$annotation_label <- df2$annotation_label %>%
#                           str_replace(" Cells", "") %>%
#                           str_replace(" Cell", "") %>%
#                           str_replace("_cell", "") %>%
#                           str_replace(" cell", "") %>%
#                           str_replace("Cardiomyocytes", "Cardiomyocyte") %>%
#                           str_replace("Cardiomycoyte", "Cardiomyocyte") %>%
#                           str_replace("Adipocytes", "Adipocyte") %>%
#                           str_replace("Ilc", "ILC")
```

#### Pivot - Identification of Common Cell Types

The goal of this pivot table is to generate descriptive statistics for cell types associated with anatomical structures. Data is aggregated to identify cell types associated with given organ anatomical structures, and the tools that generated the cell type analysis results. Cell type statistics include, the count of anatomical structures related to a cell type, the mean & median of a cell type percentage measure.

```{r piv-vt}
# Pivot 1 - Count Records
piv1 <- df2 %>% 
  filter(asct_relation_in_asctb_table == 'true' |
         indirect_asct_relation_in_asctb_table == 'true') %>%
  select(tool, organ, as, cell_id, cell_label, annotation_label, 
         cell_count, percentage) %>% 
  #mutate(as = factor(as)) %>%
  ddply(.(tool, organ, as, cell_id, annotation_label), summarise,
        measure_ct = length(cell_count),
        mean_cell_ct = mean(cell_count),
        median_cell_ct = median(cell_count),
        mean_cell_per = mean(percentage),
        median_cell_per = median(percentage))

# Pivot 2 - Count AS
piv2 <- piv1 %>% 
  ddply(.(tool, organ, cell_id, annotation_label), summarise,
        as_ct = length(as),
        measure_ct = sum(measure_ct),
        mean_cell_ct = mean(mean_cell_ct),
        median_cell_ct = median(median_cell_ct),
        mean_cell_per = mean(mean_cell_per),
        median_cell_per = median(median_cell_per)) %>% 
  arrange(tool, desc(median_cell_per)) %>%
  group_by(organ, tool) %>%
  mutate(rank = rank(-median_cell_per))

# Pivot 2 - Count Organ
piv3 <- piv2 %>%  
  ddply(.(tool, cell_id, annotation_label), summarise,
        og_ct = length(organ),
        as_ct = sum(as_ct),
        measure_ct = sum(measure_ct),
        mean_cell_ct = mean(mean_cell_ct),
        median_cell_ct = median(median_cell_ct),
        mean_cell_per = mean(mean_cell_per),
        median_cell_per = median(median_cell_per)) %>%
  arrange(tool, desc(og_ct), desc(median_cell_per)) %>%
  group_by(tool) %>%
  mutate(rank = rank(-median_cell_per))

# Create filters of common cell types to exclude from analysis
cell_filter <- piv3 %>%
  ungroup() %>%
  filter(og_ct >= 2) %>%
  select(cell_id) %>%
  distinct() 
```

### Visualization

Base design for 100% stacked bar graphs representing the cell types commonly identified in anatomical structures within donated organs.

Bar graph definition:

Stacked bar represent top cell types associated with an organ anatomical structure
* Data threshold: 8% minimum cell percentage values (or mean cell percentage values PER AS)
* Bars - anatomical structure categories.
  * Bar segment-area-Cell Type percentage measures
    * Bar/Bar segments should total to at most 1 or 100%.
    * Mean cell type percentage calculation-tool, sex organ, as
  * Bar segment-color-cell types categories.
* Facets represent combination of analytic tool and gender.

#### Heart - Anatomical Structure - Cell Types

The code chunk documents the general process used to prepare data for visualizations. In the first step, we subset data related to an single organ. Next, assign the best cell type name associated with an organ, based on the cell type annotation tool used. These tool subsets are re-combined and clean cell label is created. After cleaning the cell identifiers, the data is aggregated to determine the mean count and percentage of a cell types associated with tissue registration data, based on donor sex, analysis tools, and anatomical structure of an organ. After aggregation, cell types that make up at least 8% of cell type populations are selected for visualization. 

```{r bar_heart, echo=TRUE, fig.height=12, fig.width=14, message=FALSE, warning=FALSE}
# Subset df2 to relevant organ
barGraph <- df2[df2$organ==levels(df$organ)[1],]

# Filter cell types to remove multi-organ cell types.
# Calculate the cell count and mean percentage of cell types by AS-CT, by tool.
barGraph <- barGraph %>%
  filter(!cell_id %in% cell_filter$cell_id) %>%
  select(organ,as,cell_id,cell_label,annotation_label,
         cell_count,percentage,tool,sex) %>%
  mutate(cell_lab = paste0(cell_id,": ",annotation_label)) %>%
  ddply(.(sex,tool,as,cell_lab), summarise,
        ct = length(cell_count),
        mean_cell_count = mean(cell_count),
        mean_percentage = mean(percentage)) %>%
  arrange(sex, tool, as, desc(mean_percentage)) %>%
  group_by(sex, tool, as) %>%
  mutate(rank = row_number()) %>%
  ungroup()

# Factoring AS and Cell Types for Heart
barGraph$as <- factor(barGraph$as, 
                 levels=c("Left Ventricle","Right Ventricle",
                          "Posteromedial Head of Posterior Papillary Muscle Of Left Ventricle",
                          "Interventricular Septum","Left Cardiac Atrium","Right Cardiac Atrium"),
                 labels=c("Left Ventricle","Right Ventricle","Left Ventricle",
                          "Interventricular Septum","Left Cardiac Atrium","Right Cardiac Atrium"))

barGraph$cell_lab <- factor(barGraph$cell_lab,
                            levels=c("CL:0000077: Meso",
                                    "CL:0000077: Mesothelial",
                                    "CL:0000136: Adip1",
                                    "CL:0000136: Adipocyte",
                                    "CL:0000182: Hepatocyte",
                                    "CL:0000451: Dc",
                                    "CL:0000492: Cd4+T_tfh",
                                    "CL:0000545: Cd4+T_th1",
                                    "CL:0000546: Cd4+T_th2",
                                    "CL:0000899: Cd4+T_th17",
                                    "CL:0000792: Cd4+T_reg",
                                    "CL:0000895: Cd4+T_naive",
                                    "CL:0001043: Cd4+T_act",
                                    "CL:0000794: Cd8+T_cytox",
                                    "CL:0000913: Cd8+T_em",
                                    "CL:0001050: Cd8+T_te",
                                    "CL:0002057: Cd14+Mo",
                                    "CL:0002396: Cd16+Mo",
                                    "CL:0000623: Nk",
                                    "CL:0000938: Nk_cd56hi",
                                    "CL:0000939: Nk_cd16hi",
                                    "CL:0000814: T/NK cycling",
                                    "CL:0000669: PC1 vent",
                                    "CL:0000669: PC2 atria",
                                    "CL:0000669: PC3 str",
                                    "CL:0000669: Pericyte",
                                    "CL:0000746: Cardiac Muscle Cell",
                                    "CL:0000359: Smc1_basic",
                                    "CL:0000791: MAIT-like",
                                    "CL:0000798: Gdt",
                                    "CL:0001065: Ilc",
                                    "CL:0002068: Purkinje_cell",
                                    "CL:0002072: Avn_p_cell",
                                    "CL:0010005: Avn_bundle_cell",
                                    "CL:0002129: aCM1",
                                    "CL:0002129: aCM3",
                                    "CL:0002129: aCM4",
                                    "CL:0002129: aCM5",
                                    "CL:0002129: Atrial Cardiomyocyte",
                                    "CL:0002131: vCM1",
                                    "CL:0002131: vCM3 stressed",
                                    "CL:0002131: vCM4",
                                    "CL:0002131: Ventricular Cardiomycoyte",
                                    "CL:0000115: EC10 CMC-like",
                                    "CL:0000115: EC4 immune",
                                    "CL:0000115: Endothelial",
                                    "CL:0010008: Cardiac Endothelial Cell",
                                    "CL:1000413: Arterial Endothelial",
                                    "CL:1000414: Venous Endothelial",
                                    "CL:0002144: Capillary Endothelial",
                                    "CL:0002144: EC1 cap",
                                    "CL:0002144: EC2 cap",
                                    "CL:0002350: Ec7_endocardial",
                                    "CL:0002350: Endocardial",
                                    "CL:1000413: Ec5_art",
                                    "CL:0002543: Ec6_ven",
                                    "CL:0002548: Fibroblast Of Cardiac Tissue",
                                    "CL:0002573: Neuronal",
                                    "CL:0010020: NC1 glial",
                                    "CL:0011031: Monocyte/Cdc",
                                    "CL:1000477: San_p_cell"),
                            labels=c("CL:0000077: Mesothelial",
                                    "CL:0000077: Mesothelial",
                                    "CL:0000136: Adipocyte",
                                    "CL:0000136: Adipocyte",
                                    "CL:0000182: Hepatocyte",
                                    "CL:0000451: Dc",
                                    "CL:0000492: Cd4+T tfh",
                                    "CL:0000545: Cd4+T th1",
                                    "CL:0000546: Cd4+T th2",
                                    "CL:0000899: Cd4+T th17",
                                    "CL:0000792: Cd4+T reg",
                                    "CL:0000895: Cd4+T naive",
                                    "CL:0001043: Cd4+T act",
                                    "CL:0000794: Cd8+T cytox",
                                    "CL:0000913: Cd8+T em",
                                    "CL:0001050: Cd8+T te",
                                    "CL:0002057: Cd14+Mo",
                                    "CL:0002396: Cd16+Mo",
                                    "CL:0000623: NK",
                                    "CL:0000938: NK cd56hi",
                                    "CL:0000939: NK cd16hi",
                                    "CL:0000814: T/NK cycling",
                                    "CL:0000669: PC1 vent",
                                    "CL:0000669: PC2 atria",
                                    "CL:0000669: PC3 str",
                                    "CL:0000669: Pericyte",
                                    "CL:0000746: Cardiac Muscle Cell",
                                    "CL:0000359: SMC1 Basic",
                                    "CL:0000791: MAIT-like",
                                    "CL:0000798: GDT",
                                    "CL:0001065: Ilc",
                                    "CL:0002068: Purkinje Cell",
                                    "CL:0002072: AVN P Cell",
                                    "CL:0010005: AVN Bundle Cell",
                                    "CL:0002129: Atrial Cardiomyocyte",
                                    "CL:0002129: Atrial Cardiomyocyte",
                                    "CL:0002129: Atrial Cardiomyocyte",
                                    "CL:0002129: Atrial Cardiomyocyte",
                                    "CL:0002129: Atrial Cardiomyocyte",
                                    "CL:0002131: Ventricular Cardiomycoyte",
                                    "CL:0002131: Ventricular Cardiomycoyte",
                                    "CL:0002131: Ventricular Cardiomycoyte",
                                    "CL:0002131: Ventricular Cardiomycoyte",
                                    "CL:0000115: Endothelial",
                                    "CL:0000115: Endothelial",
                                    "CL:0000115: Endothelial",
                                    "CL:0010008: Cardiac Endothelial Cell",
                                    "CL:1000413: Arterial Endothelial",
                                    "CL:1000414: Venous Endothelial",
                                    "CL:0002144: Capillary Endothelial",
                                    "CL:0002144: Capillary Endothelial",
                                    "CL:0002144: Capillary Endothelial",
                                    "CL:0002350: Endocardial",
                                    "CL:0002350: Endocardial",
                                    "CL:1000413: EC5_art",
                                    "CL:0002543: EC6_ven",
                                    "CL:0002548: Fibroblast Of Cardiac Tissue",
                                    "CL:0002573: Neuronal",
                                    "CL:0010020: NC1 glial",
                                    "CL:0011031: Monocyte/Cdc",
                                    "CL:1000477: San P cell"))
#barGraph$cell_lab <- factor(barGraph$cell_lab)
levels(barGraph$cell_lab)
# Set color palette for cell types 
color_pal_kid2 <- c("#B3E5FC","#03A9F4","#0288D1","#01579B","#E8F5E9","#C8E6C9",
                    "#A5D6A7","#81C784","#66BB6A","#4CAF50","#43A047","#B2DFDB",
                    "#4DB6AC","#009688","#4FC3F7","#03A9F4","#512DA8","#673AB7",
                    "#9575CD","#D1C4E9","#B2EBF2","#4DD0E1","#00BCD4","#0097A7",
                    "#F48FB1","#FCE4EC","#FFE082","#6D4C41","#FFCA28","#FFA000",
                    "#C2185B","#880E4F","#8BC34A","#558B2F","#FF5722","#283593",
                    "#3949AB","#5C6BC0","#9FA8DA","#E8EAF6","#FF8A65","#FFCCBC",
                    "#EFEBE9","#BCAAA4","#8D6E63","#4E342E","#3E2723")

# Plot
barGraph_plot <- 
  barGraph %>% 
  arrange(sex,tool,as,mean_percentage) %>%
  ggplot(aes(x=as,y=mean_percentage)) +
    geom_bar(aes(fill=cell_lab), stat="identity") +
    facet_wrap(facets=vars(tool, sex), ncol=2) +
    labs(x="Anatomical Structure", y="Percentage (%)",
         title="Heart Anatomical Structures - Cell Types by Donor Sex and Analysis Tool") +
    scale_fill_manual(name="Cell Type", values=color_pal_kid2) +
    scale_y_continuous(expand = c(0,0),limits=c(0,1.05)) +
    theme_light() +
    theme(legend.position = "bottom",
          legend.title = element_text(face="bold", size=10),
          legend.key.spacing.y = unit(.3,"pt"),
          strip.background = element_rect(fill = "#cdcecf"),
          strip.text = element_text(color="black", size=10, hjust=0))

# Export PDF & PNG files
ggsave(file=paste0("../output/barplots/heart_as_celltype_bargraph_0.3.pdf"),
       barGraph_plot, width=14, height=12, units="in")
ggsave(file=paste0("../output/barplots/heart_as_celltype_bargraph_0.3.png"),
       barGraph_plot, width=14, height=12, units="in")

barGraph_plot
```

#### Lung - Anatomical Structure - Cell Types

```{r bar_lung, fig.height=12, fig.width=14, message=FALSE, warning=FALSE, paged.print=FALSE}
# Subset df2 to relevant organ - Lung
barGraph <- df2[df2$organ==levels(df$organ)[6],]

# Filter cell types to remove multi-organ cell types.
# Calculate the cell count and mean percentage of cell types by AS-CT, by tool.
barGraph <- barGraph %>%
  filter(!cell_id %in% cell_filter$cell_id) %>%
  select(organ,as,cell_id,cell_label,annotation_label,
         cell_count,percentage,tool,sex) %>%
  mutate(cell_lab = paste0(cell_id,": ",annotation_label)) %>%
  ddply(.(sex,tool,as,cell_lab), summarise,
        ct = length(cell_count),
        mean_cell_count = mean(cell_count),
        mean_percentage = mean(percentage)) %>%
  arrange(sex, tool, as, desc(mean_percentage)) %>%
  group_by(sex, tool, as) %>%
  mutate(rank = row_number()) %>%
  ungroup()

# Factor Lung AS
barGraph$as <- factor(barGraph$as, 
                     levels=c("Lateral Bronchopulmonary Segment",
                              "Lateral Segmental Bronchus",
                              "Left Apical Bronchopulmonary Segment",
                              "Medial Bronchopulmonary Segment"),
                     labels=c("Lateral\nBronchopulmonary\nSegment",
                              "Lateral\nSegmental\nBronchus",
                              "Left Apical\nBronchopulmonary\nSegment",
                              "Medial\nBronchopulmonary\nSegment"))


# barGraph$cell_lab <- factor(barGraph$cell_lab)
# levels(barGraph$cell_lab)

# # Factor Lung Cell Types
barGraph$cell_lab <- factor(barGraph$cell_lab,
                            levels=c("ASCTB-TEMP:alveolar-m-proliferating: Alveolar Mφ proliferating",
                                    "ASCTB-TEMP:interstitial-m-perivascular: Interstitial Mφ perivascular",
                                    "ASCTB-TEMP:monocyte-derived-m: Monocyte-derived Mφ",
                                    "ASCTB-TEMP:non-classical-monocytes: Non-classical monocytes",
                                    "ASCTB-TEMP:transitional-club-at2: Transitional Club-AT2",
                                    "CL:0000037: Hematopoietic Stem Cells",
                                    "CL:0000158: Club (nasal)",
                                    "CL:0000158: Club (non-nasal)",
                                    "CL:0000158: Club (Non-Nasal)",
                                    "CL:0000158: Club Cell",
                                    "CL:0000158: Hillock-like",
                                    "CL:0000165: Neuroendocrine",
                                    "CL:0000451: Dendritic Cell",
                                    "CL:0000492: Cd4 T Cells",
                                    "CL:0000492: CD4 T cells",
                                    "CL:0001044: Effector Cd4-Positive, Alpha-Beta T Cell",
                                    "CL:0000913: Cd8 T Cells",
                                    "CL:0000913: CD8 T cells",
                                    "CL:0001050: Effector Cd8-Positive, Alpha-Beta T Cell",
                                    "CL:0000576: Classical monocytes",
                                    "CL:0000576: Classical Monocytes",
                                    "CL:0000860: Classical Monocyte",
                                    "CL:0000875: Non-Classical Monocyte",
                                    "CL:0000875: Non-Classical Monocytes",
                                    "CL:0002393: Intermediate Monocyte",
                                    "CL:0000583: Alveolar macrophages",
                                    "CL:0000583: Alveolar Macrophages",
                                    "CL:0000623: Nk Cells",
                                    "CL:0000623: NK cells",
                                    "CL:0000814: Mature Nk T Cell",
                                    "CL:0000646: Basal Cell",
                                    "CL:0000767: Basophil",
                                    "CL:0002633: Basal resting",
                                    "CL:0002633: Suprabasal",
                                    "CL:0000669: Pericyte",
                                    "CL:0000669: Pericytes",
                                    "CL:0009089: Pericytes",
                                    "CL:0000784: Plasmacytoid Dcs",
                                    "CL:0000784: Plasmacytoid Dendritic Cell",
                                    "CL:0001058: Plasmacytoid DCs",
                                    "CL:0001056: Migratory DCs",
                                    "CL:0002394: Dc1",
                                    "CL:0002399: Dc2",
                                    "CL:0002399: DC2",
                                    "CL:0002062: At1",
                                    "CL:0002062: AT1",
                                    "CL:0002062: Type I Pneumocyte",
                                    "CL:0002063: At2",
                                    "CL:0002063: AT2",
                                    "CL:0002063: Type Ii Pneumocyte",
                                    "CL:0002075: Tuft",
                                    "CL:0002370: Respiratory Goblet Cell",
                                    "CL:0002480: Goblet (nasal)",
                                    "CL:0002480: Goblet (Nasal)",
                                    "CL:0019003: Goblet (bronchial)",
                                    "CL:0019003: Goblet (Bronchial)",
                                    "CL:1000312: Goblet (subsegmental)",
                                    "CL:0002598: Bronchial Smooth Muscle Cell",
                                    "CL:0000359: Vascular Associated Smooth Muscle Cell",
                                    "CL:0005012: Multiciliated (nasal)",
                                    "CL:0005012: Multiciliated (non-nasal)",
                                    "CL:0010003: AT0",
                                    "CL:0005006: Ionocyte",
                                    "CL:0017000: Pulmonary Ionocyte",
                                    "CL:0019001: pre-TB secretory",
                                    "CL:1000271: Lung Ciliated Cell",
                                    "CL:0000071: Blood Vessel Endothelial Cell",
                                    "CL:1000413: Ec Arterial",
                                    "CL:1000413: EC arterial",
                                    "CL:1000413: Endothelial Cell Of Artery",
                                    "CL:0002543: Vein Endothelial Cell",
                                    "CL:1000414: EC venous pulmonary",
                                    "CL:1000414: Ec Venous Systemic",
                                    "CL:0002144: Capillary Endothelial Cell",
                                    "CL:0002144: Ec General Capillary",
                                    "CL:0002144: EC general capillary",
                                    "CL:4028003: Ec Aerocyte Capillary",
                                    "CL:4028003: EC aerocyte capillary",
                                    "CL:2000016: Lung Microvascular Endothelial Cell",
                                    "CL:1000491: Mesothelium",
                                    "CL:1001603: Monocyte-derived Mph",
                                    "CL:4033041: Alveolar Mph Ccl3+",
                                    "CL:4033042: Alveolar Mph Mt-Positive",
                                    "CL:4033043: Interstitial Mph perivascular",
                                    "CL:0000186: Myofibroblasts",
                                    "CL:0002241: Peribronchial fibroblasts",
                                    "CL:0002241: Peribronchial Fibroblasts",
                                    "CL:4023054: Subpleural Fibroblasts",
                                    "CL:4028004: Alveolar fibroblasts",
                                    "CL:4028004: Alveolar Fibroblasts",
                                    "CL:4028006: Adventitial Cell",
                                    "CL:4028006: Adventitial fibroblasts",
                                    "CL:4028006: Adventitial Fibroblasts",
                                    "CL:1000331: Serous Cell Of Epithelium Of Bronchus",
                                    "CL:0000313: SM activated stress response",
                                    "CL:0000313: SMG serous (nasal)",
                                    "CL:4033005: Smg Serous (Bronchial)",
                                    "CL:4033022: Smg Mucous",
                                    "CL:4033022: SMG mucous",
                                    "CL:4033023: Smg Duct",
                                    "CL:4033023: SMG duct",
                                    "CL:4033044: Deuterosomal"),
                           labels=c("ASCTB-TEMP:alveolar-m-proliferating: Alveolar Mφ proliferating",
                                    "ASCTB-TEMP:interstitial-m-perivascular: Interstitial Mφ perivascular",
                                    "ASCTB-TEMP:monocyte-derived-m: Monocyte-derived Mφ",
                                    "ASCTB-TEMP:non-classical-monocytes: Non-classical monocytes",
                                    "ASCTB-TEMP:transitional-club-at2: Transitional Club-AT2",
                                    "CL:0000037: Hematopoietic Stem Cell",
                                    "CL:0000158: Club Cell",
                                    "CL:0000158: Club Cell",
                                    "CL:0000158: Club Cell",
                                    "CL:0000158: Club Cell",
                                    "CL:0000158: Hillock-like",
                                    "CL:0000165: Neuroendocrine",
                                    "CL:0000451: Dendritic Cell",
                                    "CL:0000492: CD4 T Cell",
                                    "CL:0000492: CD4 T Cell",
                                    "CL:0001044: Effector Cd4-Positive, Alpha-Beta T Cell",
                                    "CL:0000913: CD8 T Cell",
                                    "CL:0000913: CD8 T Cell",
                                    "CL:0001050: Effector Cd8-Positive, Alpha-Beta T Cell",
                                    "CL:0000576: Classical Monocyte",
                                    "CL:0000576: Classical Monocyte",
                                    "CL:0000860: Classical Monocyte",
                                    "CL:0000875: Non-Classical Monocyte",
                                    "CL:0000875: Non-Classical Monocyte",
                                    "CL:0002393: Intermediate Monocyte",
                                    "CL:0000583: Alveolar Macrophage",
                                    "CL:0000583: Alveolar Macrophage",
                                    "CL:0000623: NK Cell",
                                    "CL:0000623: NK Cell",
                                    "CL:0000814: Mature NK T Cell",
                                    "CL:0000646: Basal Cell",
                                    "CL:0000767: Basophil",
                                    "CL:0002633: Suprabasal",
                                    "CL:0002633: Suprabasal",
                                    "CL:0000669: Pericytes",
                                    "CL:0000669: Pericytes",
                                    "CL:0009089: Pericytes",
                                    "CL:0000784: Plasmacytoid Dendritic Cell",
                                    "CL:0000784: Plasmacytoid Dendritic Cell",
                                    "CL:0001058: Plasmacytoid Dendritic Cell",
                                    "CL:0001056: Migratory Dendritic Cell",
                                    "CL:0002394: DC1",
                                    "CL:0002399: DC2",
                                    "CL:0002399: DC2",
                                    "CL:0002062: Type I Pneumocyte",
                                    "CL:0002062: Type I Pneumocyte",
                                    "CL:0002062: Type I Pneumocyte",
                                    "CL:0002063: Type II Pneumocyte",
                                    "CL:0002063: Type II Pneumocyte",
                                    "CL:0002063: Type II Pneumocyte",
                                    "CL:0002075: Tuft",
                                    "CL:0002370: Respiratory Goblet Cell",
                                    "CL:0002480: Goblet (Nasal)",
                                    "CL:0002480: Goblet (Nasal)",
                                    "CL:0019003: Goblet (Bronchial)",
                                    "CL:0019003: Goblet (Bronchial)",
                                    "CL:1000312: Goblet (subsegmental)",
                                    "CL:0002598: Bronchial Smooth Muscle Cell",
                                    "CL:0000359: Vascular Associated Smooth Muscle Cell",
                                    "CL:0005012: Multiciliated (nasal)",
                                    "CL:0005012: Multiciliated (non-nasal)",
                                    "CL:0010003: AT0",
                                    "CL:0005006: Ionocyte",
                                    "CL:0017000: Pulmonary Ionocyte",
                                    "CL:0019001: pre-TB Secretory",
                                    "CL:1000271: Lung Ciliated Cell",
                                    "CL:0000071: Blood Vessel Endothelial Cell",
                                    "CL:1000413: Artery Endothelial Cell",
                                    "CL:1000413: Artery Endothelial Cell",
                                    "CL:1000413: Artery Endothelial Cell",
                                    "CL:0002543: Vein Endothelial Cell",
                                    "CL:1000414: EC Venous Pulmonary",
                                    "CL:1000414: EC Venous Pulmonary",
                                    "CL:0002144: Capillary Endothelial Cell",
                                    "CL:0002144: Capillary Endothelial Cell",
                                    "CL:0002144: Capillary Endothelial Cell",
                                    "CL:4028003: EC Aerocyte Capillary",
                                    "CL:4028003: EC Aerocyte Capillary",
                                    "CL:2000016: Lung Microvascular Endothelial Cell",
                                    "CL:1000491: Mesothelium",
                                    "CL:1001603: Monocyte-derived Mph",
                                    "CL:4033041: Alveolar Mph Ccl3+",
                                    "CL:4033042: Alveolar Mph Mt-Positive",
                                    "CL:4033043: Interstitial Mph perivascular",
                                    "CL:0000186: Myofibroblasts",
                                    "CL:0002241: Peribronchial Fibroblasts",
                                    "CL:0002241: Peribronchial Fibroblasts",
                                    "CL:4023054: Subpleural Fibroblasts",
                                    "CL:4028004: Alveolar Fibroblasts",
                                    "CL:4028004: Alveolar Fibroblasts",
                                    "CL:4028006: Adventitial Fibroblasts",
                                    "CL:4028006: Adventitial Fibroblasts",
                                    "CL:4028006: Adventitial Fibroblasts",
                                    "CL:1000331: Serous Cell Of Epithelium Of Bronchus",
                                    "CL:0000313: SMG Serous (Nasal)",
                                    "CL:0000313: SMG Serous (Nasal)",
                                    "CL:4033005: SMG Serous (Bronchial)",
                                    "CL:4033022: SMG Mucous",
                                    "CL:4033022: SMG Mucous",
                                    "CL:4033023: SMG Duct",
                                    "CL:4033023: SMG Duct",
                                    "CL:4033044: Deuterosomal"))

# Colors 
# color_pal_kid <- c("#CD8490","#AADCDF","#88B1B3",
#                    "#BAD2E7","#9AADBE","#7E8E9C","#626F7A",
#                    "#D6B6D7","#AB92AC",
#                    "#9C534E","#582FC5","#A1ACD2")

# Plot
barGraph_plot <- 
  barGraph %>% 
  arrange(sex,tool,as,mean_percentage) %>%
  ggplot(aes(x=as,y=mean_percentage)) +
    geom_bar(aes(fill=cell_lab), stat="identity") +
    facet_wrap(facets=vars(tool, sex), ncol=2) +
    labs(x="Anatomical Structure", y="Percentage (%)",
         title="Lung Anatomical Structures - Cell Types by Donor Sex and Analysis Tool") +
    #scale_fill_manual(name="Cell Type",values=color_pal_kid2) +
    scale_y_continuous(expand = c(0,0),limits=c(0,1.05)) +
    theme_light() +
    theme(legend.position = "bottom",
          legend.title = element_text(face="bold", size=10),
          legend.key.spacing.y = unit(.3,"pt"),
          strip.background = element_rect(fill = "#cdcecf"),
          strip.text = element_text(color="black", size=10, hjust=0)) +
    guides(fill=guide_legend(ncol=4))

# Export PDF & PNG filess
ggsave(file=paste0("../output/barplots/lung_as_celltype_bargraph_0.3.pdf"),
       barGraph_plot, width=14, height=12, units="in")
ggsave(file=paste0("../output/barplots/lung_as_celltype_bargraph_0.3.png"),
       barGraph_plot, width=14, height=12, units="in")

barGraph_plot
```


#### Kidney - Anatomical Structure - Cell Types

```{r bar_kidney, fig.height=7, fig.width=14, message=FALSE, warning=FALSE, paged.print=FALSE}
# Subset df2 to relevant organ - Kidney
barGraph <- df2[df2$organ==levels(df$organ)[2],]

# Filter cell types to remove multi-organ cell types.
# Calculate the cell count and mean percentage of cell types by AS-CT, by tool.
barGraph <- barGraph %>%
  filter(!cell_id %in% cell_filter$cell_id) %>%
  select(organ,as,cell_id,annotation_label,
         cell_count,percentage,tool,sex) %>%
  mutate(cell_lab = paste0(cell_id,": ",annotation_label)) %>%
  ddply(.(sex,tool,as,cell_lab), summarise,
        ct = length(cell_count),
        mean_cell_count = mean(cell_count),
        mean_percentage = mean(percentage)) %>%
  arrange(sex, tool, as, desc(mean_percentage)) %>%
  group_by(sex, tool, as) %>%
  mutate(rank = row_number())%>%
  ungroup()

# Factor Kidney AS
barGraph$as <- factor(barGraph$as)

# Factor Kidney Cell Types
#levels(factor(barGraph$cell_lab))
barGraph$cell_lab <- factor(barGraph$cell_lab, 
                       levels=c("ASCTB-TEMP:descending-vasa-recta-endothelial: Descending Vasa Recta Endothelial ",
                                "ASCTB-TEMP:peritubular-capilary-endothelial: Peritubular Capilary Endothelial ",
                                "CL:0000113: Cycling Mononuclear Phagocyte",
                                "CL:0000648: Renin-Positive Juxtaglomerular Granular",
                                "CL:0000650: Mesangial",
                                "CL:0000653: Podocyte",
                                "CL:0000814: Natural Killer T",
                                "CL:0000875: Non-Classical Monocyte",
                                "CL:0000890: M2 Macrophage",
                                "CL:0000990: Classical Dendritic",
                                "CL:0001058: Plasmacytoid Dendritic",
                                "CL:0002201: Intercalated Type B",
                                "CL:0002573: Schwann / Neural",
                                "CL:0011031: Monocyte-Derived",
                                "CL:1000412: Afferent / Efferent Arteriole Endothelial",
                                "CL:1001005: Glomerular Capillary Endothelial",
                                "CL:1001131: Ascending Vasa Recta Endothelial",
                                "CL:1000452: Parietal Epithelial",
                                "CL:1000597: Papillary Tip Epithelial",
                                "CL:4030009: Proximal Tubule Epithelial Segment 1",
                                "CL:4030010: Proximal Tubule Epithelial Segment 2",
                                "CL:4030011: Proximal Tubule Epithelial Segment 3",
                                "CL:1000692: Fibroblast",
                                "CL:4030022: Medullary Fibroblast",
                                "CL:1001318: Cortical Vascular Smooth Muscle / Pericyte",
                                "CL:1001318: Vascular Smooth Muscle / Pericyte",
                                "CL:1000714: Cortical Collecting Duct Principal",
                                "CL:1000715: Cortical Collecting Duct Intercalated Type A",
                                "CL:1000716: Outer Medullary Collecting Duct Principal",
                                "CL:1000717: Outer Medullary Collecting Duct Intercalated Type A",
                                "CL:1000718: Inner Medullary Collecting Duct",
                                "CL:1000850: Macula Densa",
                                "CL:1001107: Ascending Thin Limb",
                                "CL:1001108: Medullary Thick Ascending Limb",
                                "CL:1001109: Cortical Thick Ascending Limb",
                                "CL:4030012: Descending Thin Limb Type 1",
                                "CL:4030013: Descending Thin Limb Type 2",
                                "CL:4030014: Descending Thin Limb Type 3",
                                "CL:1000768: Connecting Tubule",
                                "CL:4030016: Distal Convoluted Tubule Type 1",
                                "CL:4030017: Distal Convoluted Tubule Type 2",
                                "CL:4030018: Connecting Tubule Principal",
                                "CL:4030020: Connecting Tubule Intercalated Type A"),
                       labels=c("ASCTB-TEMP:descending-vasa-recta-endothelial: Descending Vasa Recta Endothelial",
                                "ASCTB-TEMP:peritubular-capilary-endothelial: Peritubular Capilary Endothelial",
                                "CL:0000113: Cycling Mononuclear Phagocyte",
                                "CL:0000648: Renin-Positive Juxtaglomerular Granular",
                                "CL:0000650: Mesangial",
                                "CL:0000653: Podocyte",
                                "CL:0000814: NK T",
                                "CL:0000875: Non-Classical Monocyte",
                                "CL:0000890: M2 Macrophage",
                                "CL:0000990: Classical Dendritic",
                                "CL:0001058: Plasmacytoid Dendritic",
                                "CL:0002201: Intercalated Type B",
                                "CL:0002573: Schwann / Neural",
                                "CL:0011031: Monocyte-Derived",
                                "CL:1000412: Afferent / Efferent Arteriole Endothelial",
                                "CL:1001005: Glomerular Capillary Endothelial",
                                "CL:1001131: Ascending Vasa Recta Endothelial",
                                "CL:1000452: Parietal Epithelial",
                                "CL:1000597: Papillary Tip Epithelial",
                                "CL:4030009: Proximal Tubule Epithelial Segment 1",
                                "CL:4030010: Proximal Tubule Epithelial Segment 2",
                                "CL:4030011: Proximal Tubule Epithelial Segment 3",
                                "CL:1000692: Fibroblast",
                                "CL:4030022: Medullary Fibroblast",
                                "CL:1001318: Vascular Smooth Muscle/Pericyte",
                                "CL:1001318: Vascular Smooth Muscle/Pericyte",
                                "CL:1000714: Cortical Collecting Duct Principal",
                                "CL:1000715: Cortical Collecting Duct Intercalated Type A",
                                "CL:1000716: Outer Medullary Collecting Duct Principal",
                                "CL:1000717: Outer Medullary Collecting Duct Intercalated Type A",
                                "CL:1000718: Inner Medullary Collecting Duct",
                                "CL:1000850: Macula Densa",
                                "CL:1001107: Ascending Thin Limb",
                                "CL:1001108: Medullary Thick Ascending Limb",
                                "CL:1001109: Cortical Thick Ascending Limb",
                                "CL:4030012: Descending Thin Limb Type 1",
                                "CL:4030013: Descending Thin Limb Type 2",
                                "CL:4030014: Descending Thin Limb Type 3",
                                "CL:1000768: Connecting Tubule",
                                "CL:4030016: Distal Convoluted Tubule Type 1",
                                "CL:4030017: Distal Convoluted Tubule Type 2",
                                "CL:4030018: Connecting Tubule Principal",
                                "CL:4030020: Connecting Tubule Intercalated Type A"))
#levels(barGraph$cell_lab)

# Color 
# color_pal_kid2 <- c("#7495AF","#70A5A8","#AADCDF","#D6B6D7","#A295C9",
#                     "#9C534E","#E97B74","#EDB8AC","#8DC599","#6F9A78","#F9CE8D","#A1ACD2",
#                     "#556E6F","#FF0043","#BAD2E7","#D8D7DB","#4B4B5E","#C4C5C6",
#                     "#A2A3A4","#818182","#5F6060","#3D3E3E","#cdcecf")

barGraph_plot <- barGraph %>% 
  arrange(sex,tool,as,mean_percentage) %>%
  ggplot(aes(x=as,y=mean_percentage)) +
    geom_bar(aes(fill=cell_lab), stat="identity") +
    facet_wrap(facets=vars(tool, sex)) +
    labs(x="Anatomical Structure", y="Percentage (%)",
         title="Kidney Anatomical Structures - Cell Types by Donor Sex and Analysis Tool") +
    #scale_fill_manual(name="Cell Type",values=color_pal_kid2) +
    scale_y_continuous(expand = c(0,0),limits=c(0,1.05)) +
    theme_light() +
    theme(legend.position = "bottom",
          legend.title = element_text(face="bold", size=10),
         # legend.key.spacing.y = unit(.1)
          strip.background = element_rect(fill = "#cdcecf"),
          strip.text = element_text(color="black", size=10, hjust=0))

# Export PDF & PNG files
ggsave(file=paste0("../output/barplots/kidney_as_celltype_bargraph_0.3.pdf"),
       barGraph_plot, width=14, height=7, units="in")
ggsave(file=paste0("../output/barplots/kidney_as_celltype_bargraph_0.3.png"),
       barGraph_plot, width=14, height=7, units="in")

barGraph_plot
```

#### Large Intestine - Anatomical Structure - Cell Types

```{r bar_largeIntestine, fig.height=21, fig.width=14, message=FALSE, warning=FALSE, paged.print=FALSE}
# Subset df2 to relevant organ - Large Intestine
barGraph <- df2[df2$organ==levels(df$organ)[4],]

# Filter cell types to remove multi-organ cell types.
# Calculate the cell count and mean percentage of cell types by AS-CT, by tool.
barGraph <- barGraph %>%
  filter(!cell_id %in% cell_filter$cell_id) %>%
  select(organ,as,cell_id,annotation_label,
         cell_count,percentage,tool,sex) %>%
  mutate(cell_lab = paste0(cell_id,": ",annotation_label)) %>%
  ddply(.(sex,tool,as,cell_lab), summarise,
        ct = length(cell_count),
        mean_cell_count = mean(cell_count),
        mean_percentage = mean(percentage)) %>%
  arrange(sex, tool, as, desc(mean_percentage)) %>%
  group_by(sex, tool, as) %>%
  mutate(rank = row_number()) %>%
  ungroup

# Factor Organ AS  
barGraph$as <- factor(barGraph$as, 
                      levels=c("Caecum","Ascending Colon","Transverse Colon",
                               "Descending Colon","Sigmoid Colon","Rectum"))
# Factor Cell Types
# levels(factor(barGraph$cell_lab))
barGraph$cell_lab <- factor(barGraph$cell_lab, 
                           levels=c("ASCTB-TEMP:-cells-ins-: β cells (INS+)",
                                    "ASCTB-TEMP:activated-cd4-t: Activated CD4 T",
                                    "ASCTB-TEMP:activated-cd8-t: Activated CD8 T",
                                    "ASCTB-TEMP:activated-t: Activated T",
                                    "ASCTB-TEMP:adult-glia: Adult Glia",
                                    "ASCTB-TEMP:angiogenic-pericyte: angiogenic pericyte",
                                    "ASCTB-TEMP:arterial-capillary: arterial capillary",
                                    "ASCTB-TEMP:b: B",
                                    "ASCTB-TEMP:best2-goblet-cell: BEST2+ Goblet cell",
                                    "ASCTB-TEMP:best4-epithelial: BEST4+ epithelial",
                                    "ASCTB-TEMP:branch-a1-imn-: Branch A1 (iMN)",
                                    "ASCTB-TEMP:branch-a2-ipan-in-: Branch A2 (IPAN/IN)",
                                    "ASCTB-TEMP:branch-a3-ipan-in-: Branch A3 (IPAN/IN)",
                                    "ASCTB-TEMP:branch-a4-in-: Branch A4 (IN)",
                                    "ASCTB-TEMP:branch-b1-emn-: Branch B1 (eMN)",
                                    "ASCTB-TEMP:branch-b2-emn-: Branch B2 (eMN)",
                                    "ASCTB-TEMP:branch-b3-ipan-: Branch B3 (IPAN)",
                                    "ASCTB-TEMP:cd4-t-cell: CD4+ T cell",
                                    "ASCTB-TEMP:cd57-enterocyte: CD57+ Enterocyte",
                                    "ASCTB-TEMP:cd66-enterocyte: CD66+ Enterocyte",
                                    "ASCTB-TEMP:cd7-immune: CD7+ Immune",
                                    "ASCTB-TEMP:cd8-t: CD8+ T",
                                    "ASCTB-TEMP:cd8-tmem: CD8 Tmem",
                                    "ASCTB-TEMP:cdc1: cDC1",
                                    "ASCTB-TEMP:cdc2: cDC2",
                                    "ASCTB-TEMP:clc-mast-cell: CLC+ Mast cell",
                                    "ASCTB-TEMP:cldn10-cells: CLDN10+ cells",
                                    "ASCTB-TEMP:clp: CLP",
                                    "ASCTB-TEMP:colonocyte: Colonocyte",
                                    "ASCTB-TEMP:contractile-pericyte-pln-: Contractile pericyte (PLN+)",
                                    "ASCTB-TEMP:cx3cr1-cd8-tmem: CX3CR1+ CD8 Tmem",
                                    "ASCTB-TEMP:cycling-b-cell: Cycling B cell",
                                    "ASCTB-TEMP:cycling-ec: cycling EC",
                                    "ASCTB-TEMP:cycling-encc-glia: cycling ENCC/glia",
                                    "ASCTB-TEMP:cycling-neuroblast: cycling neuroblast",
                                    "ASCTB-TEMP:cycling-plasma-cell: Cycling plasma cell",
                                    "ASCTB-TEMP:cycling-stromal: cycling stromal",
                                    "ASCTB-TEMP:cycling-ta: Cycling TA",
                                    "ASCTB-TEMP:d-cells-sst-: D cells (SST+)",
                                    "ASCTB-TEMP:dc: DC",
                                    "ASCTB-TEMP:differentiating-glia: Differentiating glia",
                                    "ASCTB-TEMP:distal-progenitor: Distal progenitor",
                                    "ASCTB-TEMP:dz-gc-cell: DZ GC cell",
                                    "ASCTB-TEMP:ec-cells-npw-: EC cells (NPW+)",
                                    "ASCTB-TEMP:ec-cells-tac1-: EC cells (TAC1+)",
                                    "ASCTB-TEMP:eecs: EECs",
                                    "ASCTB-TEMP:encc-glia-progenitor: ENCC/glia Progenitor",
                                    "ASCTB-TEMP:endothelial: Endothelial",
                                    "ASCTB-TEMP:enterocyte: Enterocyte",
                                    "ASCTB-TEMP:fcrl4-memory-b: FCRL4+ Memory B",
                                    "ASCTB-TEMP:fdc: FDC",
                                    "ASCTB-TEMP:fetal-arterial-ec: Fetal arterial EC",
                                    "ASCTB-TEMP:fetal-venous-ec: Fetal venous EC",
                                    "ASCTB-TEMP:gc-b-cell: GC B cell",
                                    "ASCTB-TEMP:gdt: gdT",
                                    "ASCTB-TEMP:germ: Germ",
                                    "ASCTB-TEMP:glia-1-dhh-: Glia 1 (DHH+)",
                                    "ASCTB-TEMP:glia-2-eln-: Glia 2 (ELN+)",
                                    "ASCTB-TEMP:glia-3-bcan-: Glia 3 (BCAN+)",
                                    "ASCTB-TEMP:goblet-cell: Goblet cell",
                                    "ASCTB-TEMP:goblet: Goblet",
                                    "ASCTB-TEMP:i-cells-cck-: I cells (CCK+)",
                                    "ASCTB-TEMP:icc: ICC",
                                    "ASCTB-TEMP:iga-plasma-cell: IgA plasma cell",
                                    "ASCTB-TEMP:igg-plasma-cell: IgG plasma cell",
                                    "ASCTB-TEMP:igm-plasma-cell: IgM plasma cell",
                                    "ASCTB-TEMP:ilc2: ILC2",
                                    "ASCTB-TEMP:ilc3: ILC3",
                                    "ASCTB-TEMP:ilcp: ILCP",
                                    "ASCTB-TEMP:immature-b: Immature B",
                                    "ASCTB-TEMP:immature-pericyte: Immature pericyte",
                                    "ASCTB-TEMP:k-cells-gip-: K cells (GIP+)",
                                    "ASCTB-TEMP:l-cells-pyy-: L cells (PYY+)",
                                    "ASCTB-TEMP:lec1-ackr4-: LEC1 (ACKR4+)",
                                    "ASCTB-TEMP:lec2-madcam1-: LEC2 (MADCAM1+)",
                                    "ASCTB-TEMP:lec3-adgrg3-: LEC3 (ADGRG3+)",
                                    "ASCTB-TEMP:lec4-stab2-: LEC4 (STAB2+)",
                                    "ASCTB-TEMP:lec5-cldn11-: LEC5 (CLDN11+)",
                                    "ASCTB-TEMP:lec6-adamts4-: LEC6 (ADAMTS4+)",
                                    "ASCTB-TEMP:lti-like-ncr-ilc3: LTi-like NCR- ILC3",
                                    "ASCTB-TEMP:lti-like-ncr-ilc3: LTi-like NCR+ ILC3",
                                    "ASCTB-TEMP:lymphatic: Lymphatic",
                                    "ASCTB-TEMP:lymphoid-dc: Lymphoid DC",
                                    "ASCTB-TEMP:lyve1-macrophage: LYVE1+ Macrophage",
                                    "ASCTB-TEMP:lz-gc-cell: LZ GC cell",
                                    "ASCTB-TEMP:m-x-cells-mln-ghrl-: M/X cells (MLN/GHRL+)",
                                    "ASCTB-TEMP:m1-macrophage: M1 Macrophage",
                                    "ASCTB-TEMP:m2-macrophage: M2 Macrophage",
                                    "ASCTB-TEMP:macrophages: Macrophages",
                                    "ASCTB-TEMP:mait-cell: MAIT cell",
                                    "ASCTB-TEMP:mast-cell: Mast cell",
                                    "ASCTB-TEMP:mature-arterial-ec: Mature arterial EC",
                                    "ASCTB-TEMP:mature-venous-ec: Mature venous EC",
                                    "ASCTB-TEMP:megakaryocyte: Megakaryocyte",
                                    "ASCTB-TEMP:memory-b: Memory B",
                                    "ASCTB-TEMP:mesoderm-1-hand1-: Mesoderm 1 (HAND1+)",
                                    "ASCTB-TEMP:mesoderm-2-zeb2-: Mesoderm 2 (ZEB2+)",
                                    "ASCTB-TEMP:mesothelium-prg4-: Mesothelium (PRG4+)",
                                    "ASCTB-TEMP:mesothelium-rgs5-: Mesothelium (RGS5+)",
                                    "ASCTB-TEMP:mesothelium: Mesothelium",
                                    "ASCTB-TEMP:microfold-cell: Microfold cell",
                                    "ASCTB-TEMP:mln-stroma-fmo2-: mLN Stroma (FMO2+)",
                                    "ASCTB-TEMP:mlto: mLTo",
                                    "ASCTB-TEMP:mmp9-inflammatory-macrophage: MMP9+ Inflammatory macrophage",
                                    "ASCTB-TEMP:monocytes: Monocytes",
                                    "ASCTB-TEMP:mpo-mono-neutrophil: MPO+ mono-neutrophil",
                                    "ASCTB-TEMP:muc1-enterocyte: MUC1+ Enterocyte",
                                    "ASCTB-TEMP:myofibroblast-rspo2-: myofibroblast (RSPO2+)",
                                    "ASCTB-TEMP:myofibroblast: myofibroblast",
                                    "ASCTB-TEMP:n-cells-nts-: N cells (NTS+)",
                                    "ASCTB-TEMP:naive-b: Naive B",
                                    "ASCTB-TEMP:nerve: Nerve",
                                    "ASCTB-TEMP:neuroblast: Neuroblast",
                                    "ASCTB-TEMP:neuroendocrine: Neuroendocrine",
                                    "ASCTB-TEMP:neutrophil: Neutrophil",
                                    "ASCTB-TEMP:nk-cell: NK cell",
                                    "ASCTB-TEMP:nk-t-cell: NK T cell",
                                    "ASCTB-TEMP:nk: NK",
                                    "ASCTB-TEMP:paneth: Paneth",
                                    "ASCTB-TEMP:pdc: pDC",
                                    "ASCTB-TEMP:pericyte: Pericyte",
                                    "ASCTB-TEMP:plasma: Plasma",
                                    "ASCTB-TEMP:pre-b: Pre-B",
                                    "ASCTB-TEMP:pro-b: Pro-B",
                                    "ASCTB-TEMP:progenitor-neurog3-: Progenitor (NEUROG3+)",
                                    "ASCTB-TEMP:proximal-progenitor: Proximal progenitor",
                                    "ASCTB-TEMP:rbc: RBC",
                                    "ASCTB-TEMP:sell-cd4-t: SELL+ CD4 T",
                                    "ASCTB-TEMP:sell-cd8-t: SELL+ CD8 T",
                                    "ASCTB-TEMP:smc-part1-capn3-: SMC (PART1/CAPN3+)",
                                    "ASCTB-TEMP:smc-plpp2-: SMC (PLPP2+)",
                                    "ASCTB-TEMP:smooth-muscle: Smooth muscle",
                                    "ASCTB-TEMP:stat1-naive-b: STAT1+ Naive B",
                                    "ASCTB-TEMP:stem-cells: Stem cells",
                                    "ASCTB-TEMP:stroma: Stroma",
                                    "ASCTB-TEMP:stromal-1-adamdec1-: Stromal 1 (ADAMDEC1+)",
                                    "ASCTB-TEMP:stromal-1-ccl11-: Stromal 1 (CCL11+)",
                                    "ASCTB-TEMP:stromal-2-ch25h-: Stromal 2 (CH25H+)",
                                    "ASCTB-TEMP:stromal-2-npy-: Stromal 2 (NPY+)",
                                    "ASCTB-TEMP:stromal-3-c7-: Stromal 3 (C7+)",
                                    "ASCTB-TEMP:stromal-3-kcnn3-: Stromal 3 (KCNN3+)",
                                    "ASCTB-TEMP:stromal-4-mmp1-: Stromal 4 (MMP1+)",
                                    "ASCTB-TEMP:t-reticular: T reticular",
                                    "ASCTB-TEMP:ta: TA",
                                    "ASCTB-TEMP:tfh: Tfh",
                                    "ASCTB-TEMP:th1: Th1",
                                    "ASCTB-TEMP:th17: Th17",
                                    "ASCTB-TEMP:transitional-stromal-3-c3-: Transitional Stromal 3 (C3+)",
                                    "ASCTB-TEMP:trdv2-trgv9-gdt: TRDV2/TRGV9 gdT",
                                    "ASCTB-TEMP:treg: Treg",
                                    "ASCTB-TEMP:trgv2-gdt: TRGV2 gdT",
                                    "ASCTB-TEMP:trgv4-gdt: TRGV4 gdT",
                                    "ASCTB-TEMP:trgv5-7-gdt: TRGV5/7 gdT",
                                    "ASCTB-TEMP:tuft: Tuft",
                                    "ASCTB-TEMP:venous-capillary: venous capillary",
                                    "CL:0000131: Gut Endothelial Cell",
                                    "CL:0000576: Monocyte",
                                    "CL:0002071: Enterocyte Of Epithelium Of Large Intestine",
                                    "CL:0009009: Paneth Cell Of Colon",
                                    "CL:0009011: Transit Amplifying Cell Of Colon",
                                    "CL:0009016: Intestinal Crypt Stem Cell Of Large Intestine",
                                    "CL:0019032: Intestinal Tuft Cell",
                                    "CL:1000320: Large Intestine Goblet Cell",
                                    "CL:1001516: Intestinal Enteroendocrine Cell"),
                            labels=c("ASCTB-TEMP: β cells (INS+)",
                                    "ASCTB-TEMP: Activated CD4 T",
                                    "ASCTB-TEMP: Activated CD8 T",
                                    "ASCTB-TEMP: Activated T",
                                    "ASCTB-TEMP: Adult Glia",
                                    "ASCTB-TEMP: angiogenic pericyte",
                                    "ASCTB-TEMP: arterial capillary",
                                    "ASCTB-TEMP: B",
                                    "ASCTB-TEMP: BEST2+ Goblet cell",
                                    "ASCTB-TEMP: BEST4+ epithelial",
                                    "ASCTB-TEMP: Branch A1 (iMN)",
                                    "ASCTB-TEMP: Branch A2 (IPAN/IN)",
                                    "ASCTB-TEMP: Branch A3 (IPAN/IN)",
                                    "ASCTB-TEMP: Branch A4 (IN)",
                                    "ASCTB-TEMP: Branch B1 (eMN)",
                                    "ASCTB-TEMP: Branch B2 (eMN)",
                                    "ASCTB-TEMP: Branch B3 (IPAN)",
                                    "ASCTB-TEMP: CD4+ T cell",
                                    "ASCTB-TEMP: CD57+ Enterocyte",
                                    "ASCTB-TEMP: CD66+ Enterocyte",
                                    "ASCTB-TEMP: CD7+ Immune",
                                    "ASCTB-TEMP: CD8+ T",
                                    "ASCTB-TEMP: CD8 Tmem",
                                    "ASCTB-TEMP: cDC1",
                                    "ASCTB-TEMP: cDC2",
                                    "ASCTB-TEMP: CLC+ Mast cell",
                                    "ASCTB-TEMP: CLDN10+ cells",
                                    "ASCTB-TEMP: CLP",
                                    "ASCTB-TEMP: Colonocyte",
                                    "ASCTB-TEMP: Contractile pericyte (PLN+)",
                                    "ASCTB-TEMP: CX3CR1+ CD8 Tmem",
                                    "ASCTB-TEMP: Cycling B cell",
                                    "ASCTB-TEMP: cycling EC",
                                    "ASCTB-TEMP: cycling ENCC/glia",
                                    "ASCTB-TEMP: cycling neuroblast",
                                    "ASCTB-TEMP: Cycling plasma cell",
                                    "ASCTB-TEMP: cycling stromal",
                                    "ASCTB-TEMP: Cycling TA",
                                    "ASCTB-TEMP: D cells (SST+)",
                                    "ASCTB-TEMP: DC",
                                    "ASCTB-TEMP: Differentiating glia",
                                    "ASCTB-TEMP: Distal progenitor",
                                    "ASCTB-TEMP: DZ GC cell",
                                    "ASCTB-TEMP: EC cells (NPW+)",
                                    "ASCTB-TEMP: EC cells (TAC1+)",
                                    "ASCTB-TEMP: EECs",
                                    "ASCTB-TEMP: ENCC/glia Progenitor",
                                    "ASCTB-TEMP: Endothelial",
                                    "ASCTB-TEMP: Enterocyte",
                                    "ASCTB-TEMP: FCRL4+ Memory B",
                                    "ASCTB-TEMP: FDC",
                                    "ASCTB-TEMP: Fetal arterial EC",
                                    "ASCTB-TEMP: Fetal venous EC",
                                    "ASCTB-TEMP: GC B cell",
                                    "ASCTB-TEMP: gdT",
                                    "ASCTB-TEMP: Germ",
                                    "ASCTB-TEMP: Glia 1 (DHH+)",
                                    "ASCTB-TEMP: Glia 2 (ELN+)",
                                    "ASCTB-TEMP: Glia 3 (BCAN+)",
                                    "ASCTB-TEMP: Goblet",
                                    "ASCTB-TEMP: Goblet",
                                    "ASCTB-TEMP: I cells (CCK+)",
                                    "ASCTB-TEMP: ICC",
                                    "ASCTB-TEMP: IgA plasma cell",
                                    "ASCTB-TEMP: IgG plasma cell",
                                    "ASCTB-TEMP: IgM plasma cell",
                                    "ASCTB-TEMP: ILC2",
                                    "ASCTB-TEMP: ILC3",
                                    "ASCTB-TEMP: ILCP",
                                    "ASCTB-TEMP: Immature B",
                                    "ASCTB-TEMP: Immature pericyte",
                                    "ASCTB-TEMP: K cells (GIP+)",
                                    "ASCTB-TEMP: L cells (PYY+)",
                                    "ASCTB-TEMP: LEC1 (ACKR4+)",
                                    "ASCTB-TEMP: LEC2 (MADCAM1+)",
                                    "ASCTB-TEMP: LEC3 (ADGRG3+)",
                                    "ASCTB-TEMP: LEC4 (STAB2+)",
                                    "ASCTB-TEMP: LEC5 (CLDN11+)",
                                    "ASCTB-TEMP: LEC6 (ADAMTS4+)",
                                    "ASCTB-TEMP: LTi-like NCR- ILC3",
                                    "ASCTB-TEMP: LTi-like NCR+ ILC3",
                                    "ASCTB-TEMP: Lymphatic",
                                    "ASCTB-TEMP: Lymphoid DC",
                                    "ASCTB-TEMP: LYVE1+ Macrophage",
                                    "ASCTB-TEMP: LZ GC cell",
                                    "ASCTB-TEMP: M/X cells (MLN/GHRL+)",
                                    "ASCTB-TEMP: M1 Macrophage",
                                    "ASCTB-TEMP: M2 Macrophage",
                                    "ASCTB-TEMP: Macrophages",
                                    "ASCTB-TEMP: MAIT cell",
                                    "ASCTB-TEMP: Mast cell",
                                    "ASCTB-TEMP: Mature arterial EC",
                                    "ASCTB-TEMP: Mature venous EC",
                                    "ASCTB-TEMP: Megakaryocyte",
                                    "ASCTB-TEMP: Memory B",
                                    "ASCTB-TEMP: Mesoderm 1 (HAND1+)",
                                    "ASCTB-TEMP: Mesoderm 2 (ZEB2+)",
                                    "ASCTB-TEMP: Mesothelium (PRG4+)",
                                    "ASCTB-TEMP: Mesothelium (RGS5+)",
                                    "ASCTB-TEMP: Mesothelium",
                                    "ASCTB-TEMP: Microfold cell",
                                    "ASCTB-TEMP: mLN Stroma (FMO2+)",
                                    "ASCTB-TEMP: mLTo",
                                    "ASCTB-TEMP: MMP9+ Inflammatory macrophage",
                                    "ASCTB-TEMP: Monocytes",
                                    "ASCTB-TEMP: MPO+ mono-neutrophil",
                                    "ASCTB-TEMP: MUC1+ Enterocyte",
                                    "ASCTB-TEMP: myofibroblast (RSPO2+)",
                                    "ASCTB-TEMP: myofibroblast",
                                    "ASCTB-TEMP: N cells (NTS+)",
                                    "ASCTB-TEMP: Naive B",
                                    "ASCTB-TEMP: Nerve",
                                    "ASCTB-TEMP: Neuroblast",
                                    "ASCTB-TEMP: Neuroendocrine",
                                    "ASCTB-TEMP: Neutrophil",
                                    "ASCTB-TEMP: NK cell",
                                    "ASCTB-TEMP: NK T cell",
                                    "ASCTB-TEMP: NK",
                                    "ASCTB-TEMP: Paneth",
                                    "ASCTB-TEMP: pDC",
                                    "ASCTB-TEMP: Pericyte",
                                    "ASCTB-TEMP: Plasma",
                                    "ASCTB-TEMP: Pre-B",
                                    "ASCTB-TEMP: Pro-B",
                                    "ASCTB-TEMP: Progenitor (NEUROG3+)",
                                    "ASCTB-TEMP: Proximal progenitor",
                                    "ASCTB-TEMP: RBC",
                                    "ASCTB-TEMP: SELL+ CD4 T",
                                    "ASCTB-TEMP: SELL+ CD8 T",
                                    "ASCTB-TEMP: SMC (PART1/CAPN3+)",
                                    "ASCTB-TEMP: SMC (PLPP2+)",
                                    "ASCTB-TEMP: Smooth muscle",
                                    "ASCTB-TEMP: STAT1+ Naive B",
                                    "ASCTB-TEMP: Stem cells",
                                    "ASCTB-TEMP: Stroma",
                                    "ASCTB-TEMP: Stromal 1 (ADAMDEC1+)",
                                    "ASCTB-TEMP: Stromal 1 (CCL11+)",
                                    "ASCTB-TEMP: Stromal 2 (CH25H+)",
                                    "ASCTB-TEMP: Stromal 2 (NPY+)",
                                    "ASCTB-TEMP: Stromal 3 (C7+)",
                                    "ASCTB-TEMP: Stromal 3 (KCNN3+)",
                                    "ASCTB-TEMP: Stromal 4 (MMP1+)",
                                    "ASCTB-TEMP: T reticular",
                                    "ASCTB-TEMP: TA",
                                    "ASCTB-TEMP: Tfh",
                                    "ASCTB-TEMP: Th1",
                                    "ASCTB-TEMP: Th17",
                                    "ASCTB-TEMP: Transitional Stromal 3 (C3+)",
                                    "ASCTB-TEMP: TRDV2/TRGV9 gdT",
                                    "ASCTB-TEMP: Treg",
                                    "ASCTB-TEMP: TRGV2 gdT",
                                    "ASCTB-TEMP: TRGV4 gdT",
                                    "ASCTB-TEMP: TRGV5/7 gdT",
                                    "ASCTB-TEMP: Tuft",
                                    "ASCTB-TEMP: venous capillary",
                                    "CL:0000131: Gut Endothelial Cell" ,
                                    "CL:0000576: Monocyte" ,
                                    "CL:0002071: Enterocyte Of Epithelium Of Large Intestine" ,
                                    "CL:0009009: Paneth Cell Of Colon" ,
                                    "CL:0009011: Transit Amplifying Cell Of Colon" ,
                                    "CL:0009016: Intestinal Crypt Stem Cell Of Large Intestine" ,
                                    "CL:0019032: Intestinal Tuft Cell" ,
                                    "CL:1000320: Large Intestine Goblet Cell" ,
                                    "CL:1001516: Intestinal Enteroendocrine Cell"))

# Colors
# color_pal_kid2 <- c("#F9CE8D","#556E6F","#70A5A8","#E9E4F3","#D6B6D7","#EDB8AC","#CD8490",
#                     "#AADCDF","#BAD2E7","#7495AF","#A295C9","#8DC599","#6F9A78","#E97B74",
#                     "#9C534E","#C39A5D","#A17F4D","#675868")

# Plot
barGraph_plot <- barGraph %>% 
  arrange(sex,tool,as,mean_percentage) %>%
  ggplot(aes(x=as,y=mean_percentage)) +
    geom_bar(aes(fill=cell_lab), stat="identity") +
    facet_wrap(facets=vars(tool, sex), ncol=2) +
    labs(x="Anatomical Structure", y="Percentage (%)",
         title="Large Intestine Anatomical Structures - Cell Types, by Donor Sex and Analysis Tool") +
    #scale_fill_manual(name="Cell Type",values=color_pal_kid2) +
    scale_y_continuous(expand = c(0,0),limits=c(0,1.05)) +
    theme_light() +
    theme(legend.position = "bottom",
          legend.title = element_text(face="bold", size=10),
          legend.key.spacing.y = unit(.3,"pt"),
          strip.background = element_rect(fill = "#cdcecf"),
          strip.text = element_text(color="black", size=10, hjust=0)) +
    guides(fill=guide_legend(ncol=4))

# Export PDF & PNG files
ggsave(file=paste0("../output/barplots/largeIntestine_as_celltype_bargraph_0.3.pdf"),
       barGraph_plot, width=6, height=21, units="in")
ggsave(file=paste0("../output/barplots/largeIntestine_as_celltype_bargraph_0.3.png"),
       barGraph_plot, width=14, height=21, units="in")

barGraph_plot
```

#### Small Intestine - Anatomical Structure - Cell Types

```{r bar_smallIntestine, fig.height=21, fig.width=18, message=FALSE, warning=FALSE, paged.print=FALSE}
# Subset df2 to relevant organ - Small Intestine
barGraph <- df2[df2$organ==levels(df$organ)[9],]

# Filter cell types to remove multi-organ cell types.
# Calculate the cell count and mean percentage of cell types by AS-CT, by tool.
barGraph <- barGraph %>%
  filter(!cell_id %in% cell_filter$cell_id) %>%
  select(organ,as,cell_id,annotation_label,
         cell_count,percentage,tool,sex) %>%
  mutate(cell_lab = paste0(cell_id,": ",annotation_label)) %>%
  ddply(.(sex,tool,as,cell_lab), summarise,
        ct = length(cell_count),
        mean_cell_count = mean(cell_count),
        mean_percentage = mean(percentage)) %>%
  arrange(sex, tool, as, desc(mean_percentage)) %>%
  group_by(sex, tool, as) %>%
  mutate(rank = row_number()) %>%
  ungroup

# Factor Organ AS
barGraph$as <- factor(barGraph$as, 
                     levels=c("Superior part of Duodenum", 
                              "Descending part of Duodenum",
                              "Horizontal part of Duodenum",
                              "Ascending part of Duodenum",
                              "Jejunum",
                              "Ileum",
                              "Distal part of Ileum"),
                     labels=c("Superior\nDuodenum", 
                              "Descending\nDuodenum",
                              "Horizontal\nDuodenum",
                              "Ascending\nDuodenum",
                              "Jejunum",
                              "Ileum",
                              "Distal\nIleum"))

# Factor Organ Cell Types
#levels(factor(barGraph$cell_lab)) 
# 164 cell types, mostly ASCTB
barGraph$cell_lab <- factor(barGraph$cell_lab)
                          
# Color
# color_pal_kid2 <- c("#F9CE8D","#E97B74","#556E6F","#70A5A8","#A295C9","#EDB8AC","#CD8490",
#                     "#E9E4F3","#D6B6D7","#AADCDF","#BAD2E7","#7495AF","#8DC599","#6F9A78",
#                     "#9C534E","#C39A5D","#A17F4D","#675868")

# Plot
barGraph_plot <- barGraph %>% 
  arrange(sex,tool,as,mean_percentage) %>%
  ggplot(aes(x=as,y=mean_percentage)) +
    geom_bar(aes(fill=cell_lab), stat="identity") +
    facet_wrap(facets=vars(tool, sex), ncol=2) +
    labs(x="Anatomical Structure", y="Percentage (%)",
         title="Small Intestine Anatomical Structures - Cell Types, by Donor Sex and Analysis Tool") +
    #scale_fill_manual(name="Cell Type",values=color_pal_kid2) +
    scale_y_continuous(expand = c(0,0),limits=c(0,1.05)) +
    theme_light() +
    theme(legend.position = "bottom",
          legend.title = element_text(face="bold", size=10),
          legend.key.spacing.y = unit(.3,"pt"),
          strip.background = element_rect(fill = "#cdcecf"),
          strip.text = element_text(color="black", size=10, hjust=0)) +
    guides(fill=guide_legend(ncol=4))

# Export PDF & PNG files
ggsave(file=paste0("../output/barplots/smallIntestine_as_celltype_bargraph_0.3.pdf"),
       barGraph_plot, width=18, height=21, units="in")
ggsave(file=paste0("../output/barplots/smallIntestine_as_celltype_bargraph_0.3.png"),
       barGraph_plot, width=18, height=21, units="in")

barGraph_plot
```
