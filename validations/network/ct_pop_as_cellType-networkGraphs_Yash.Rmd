---
title: "Organ, Anatomical Structures & Cell Type Bi-modal Networks - Notebook"
output:
  html_document
---

# Environment 

```{r environment, message=FALSE, warning=FALSE}
library(tidyr)
library(plyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(igraph)
library(ggraph)
library(ggnetwork)
library(stringr)

options(scipen = 999)
```

# Load Data

```{r load}
# Data - bar graph 
# Includes organ, anatomical structure, cell types measures by tool and donor gender
df <- read.csv("", 
               header=T, fileEncoding = "UTF8")

# Cell Type Crosswalks - Data Cleaning
# https://github.com/hubmapconsortium/hra-workflows-runner/tree/main/crosswalking-tables
# New version June 2024
## Azimuth
azimuth <- read.csv("https://cdn.humanatlas.io/digital-objects/ctann/azimuth/v1.0/assets/azimuth-crosswalk.csv",
                    header=T, fileEncoding = "UTF8", skip=10)

## Cell Typist
celltypist <-
  read.csv("https://cdn.humanatlas.io/digital-objects/ctann/celltypist/v1.0/assets/celltypist-crosswalk.csv", 
           header=T, fileEncoding = "UTF8", skip=10)

## PopV
popv <- read.csv("https://cdn.humanatlas.io/digital-objects/ctann/popv/v1.0/assets/popv-crosswalk.csv",
                 header=T, fileEncoding = "UTF8", skip=10)
```



```{r measures}
# Data set id for cell type measures
#data_set_ids <- unique(df$dataset_id)
# data_set_ids <- 
#   c("HBM235.VKNJ.237","HBM238.GTNW.259","HBM242.LSCK.393","HBM284.SBPR.357",
#     "HBM285.VFDT.966","HBM288.BBKK.828","HBM295.SWJJ.888","HBM297.MZZX.824",
#     "HBM334.QWFV.953","HBM353.NZVQ.793","HBM363.CKHC.928","HBM363.LLBL.252",
#     "HBM394.VSKR.883","HBM395.NQKF.566","HBM424.STVV.842","HBM429.LLRT.546",
#     "HBM438.JXJW.249","HBM439.WJDV.974","HBM443.LGZK.435","HBM447.MNKW.592",
#     "HBM462.JKCN.863","HBM465.ZNVW.226","HBM466.XSKL.867","HBM473.QGDG.848",
#     "HBM488.CNNZ.544","HBM535.QNTP.246","HBM565.LSMX.645","HBM569.NBHZ.832",
#     "HBM573.SWGH.988","HBM573.TTLG.748","HBM575.THQM.284","HBM622.STKS.394",
#     "HBM626.VJMB.795","HBM627.KDHD.293","HBM666.NDQZ.365","HBM666.RBCG.529",
#     "HBM676.QVGZ.455","HBM679.NNNK.283","HBM683.NRPR.962","HBM687.SJLD.889",
#     "HBM727.DMKG.675","HBM729.XTBN.693","HBM739.HCWP.359","HBM742.NHHQ.357",
#     "HBM749.SMWP.555","HBM772.TKCN.287","HBM785.FJVT.469","HBM792.FFJT.499",
#     "HBM823.RJNG.364","HBM824.XGWZ.857","HBM827.SJBP.777","HBM832.ZSQJ.442",
#     "HBM845.VMSZ.536","HBM852.NKST.623","HBM865.VDXC.862","HBM893.MCGS.487",
#     "HBM899.KTQM.246","HBM934.KLGL.584","HBM938.KMNW.825","HBM945.FSHR.864",
#     "HBM953.KMTG.758","HBM964.FPNH.767","HBM974.CNWK.327","HBM996.MDQH.988")

# data frane for downloaded results
data <- data.frame(id = as.character(),
                   #organ = as.character(),
                   #AS = as.character(),
                   cell_type = as.character(),
                   count = as.numeric())

# URL for collecting data set meaasurements
data_url <- "https://raw.githubusercontent.com/cns-iu/hra-ct-summaries-mx-spatial-data/main/intestine_omap_2_0001/cell_type_counts/"

# For loop to collect data with cell type measures
for(i in 1:length(data_set_ids)){
  #id <- "HBM235.VKNJ.237"
  id <- data_set_ids[i]
  tmp <- read.csv(paste0(data_url,data_set_ids[i],".csv"), header = T)
  tmp <- cbind(id,tmp)
  data <- rbind(data,tmp)
  rm(id,tmp)
}

# Factor data set identifiers
data$id <- factor(data$id)
```


# Prepare data

## Clean up Cell Labeling

```{r cell_type_labels}
## Large Intestine - 1790
largeIntestine <- df[df$organ==levels(df$organ)[4],]
# Updating cell labels using crosswalks
tmp1 <- 
  largeIntestine[largeIntestine$tool=="SC Proteomics",c(1:11)] %>%
  mutate(annotation_label=NA,
         annotation_label_ids=NA,
         cell_label2=NA)
tmp2 <- 
  join(largeIntestine[largeIntestine$tool=="popV",c(1:11)],
       popv[popv$organ_level=="large intestine" &
            popv$cell_match=="skos:exactMatch" | 
            popv$cell_match=="skos:narrowMatch", c(3:6)], 
       by="cell_id", type="left")
tmp3 <- 
  join(largeIntestine[largeIntestine$tool=="CellTypist",c(1:11)],
       celltypist[celltypist$organ_level=="intestine_L1" &
                  celltypist$cell_match=="skos:exactMatch" | 
                  celltypist$cell_match=="skos:narrowMatch", c(3:6)], 
       by="cell_id", type="left")
#Clean up names
names(tmp1) <- names(tmp2) <- names(tmp3) <- 
  c("sex","tool","modality","organ","organId","as","as_id",
    "cell_id","cell_label","cell_count", "percentage",
    "annotation_label","annotation_label_id","cell_label2")
# Combine temp files
largeIntestine <- rbind(tmp1,tmp2,tmp3) 
# Add back missing cell labels when annotation label is missing
largeIntestine[is.na(largeIntestine$annotation_label),]$cell_label2 <- 
  largeIntestine[is.na(largeIntestine$annotation_label),]$cell_label


## Small Intestine
smallIntestine <- df[df$organ==levels(df$organ)[9],]
# Updating cell labels using crosswalks
tmp1 <- 
  smallIntestine[smallIntestine$tool=="SC Proteomics",c(1:11)] %>%
  mutate(annotation_label=NA,
         annotation_label_ids=NA,
         cell_label2=NA)
tmp2 <- 
  join(smallIntestine[smallIntestine$tool=="popV",c(1:11)],
       popv[popv$organ_level=="small intestine" &
            popv$cell_match=="skos:exactMatch" | 
            popv$cell_match=="skos:narrowMatch", c(3:6)], 
       by="cell_id", type="left") 
tmp3 <- 
  join(smallIntestine[smallIntestine$tool=="CellTypist",c(1:11)],
       celltypist[celltypist$organ_level=="intestine_L1" &
                  celltypist$cell_match=="skos:exactMatch" | 
                  celltypist$cell_match=="skos:narrowMatch", c(3:6)], 
       by="cell_id", type="left")
#Clean up names
names(tmp1) <- names(tmp2) <- names(tmp3) <- 
  c("sex","tool","modality","organ","organId","as","as_id",
    "cell_id","cell_label","cell_count", "percentage",
    "annotation_label","annotation_label_id","cell_label2")
# Combine temp files
smallIntestine <- rbind(tmp1,tmp2,tmp3) 
# Add back missing cell labels when annotation label is missing
smallIntestine[is.na(smallIntestine$annotation_label),]$cell_label2 <- 
  smallIntestine[is.na(smallIntestine$annotation_label),]$cell_label


# Aggregate data to get limited set of nodes and edges.




```


## Network Extraction

This section of code is used to create networks from the validation data set. First data is subset into sets based on the cell type annotation tool used for an observation, and added to a list object that will be used in a *for loop*.

The for loop processes each tool subset to create a node list of organs, anatomical structures and cell types and an edge list that link organs to anatomical structures, and anatomical structures to cell types, creating a tree-like multi-modal network graph. After creating a node and edge list for a given data subset, results are saved as CSV files and exported to the R global environment as igraph networks from data.frames.

```{r nets_extract}
## Subset data for graphs, based on CTann tool
df_list <- list(df2[df2$tool=="Azimuth",],
                df2[df2$tool=="popV",],
                df2[df2$tool=="CellTypist",],
                df2[df2$tool=="SC Proteomics",])

## Loops through df_list to create network graphs, for each CTann tool.
for(i in 1:length(df_list)){
    ## Node list creation
    anatomical_structures <-
      df_list[[i]] %>% 
      select(tool, organ, as_id, as, cell_count) %>%
      ddply(.(tool, organ, as_id, as), summarise,
            records = length(cell_count),
            cell_count = sum(cell_count)) %>%
      mutate(id_lab = paste0(as_id," ",as),
             type = "Anatomical Structure") %>% 
      dplyr::rename(label = as,
                    partOf = organ) %>%
      select(tool, id_lab, label, type, partOf, 
             records, cell_count)
    
    cell_types <- 
      df_list[[i]] %>% 
      select(tool, organ, cell_id, cell_label, cell_count) %>%
      ddply(.(tool, cell_id), summarise,
            label = head(cell_label)[1],
            records = length(cell_count),
            cell_count = sum(cell_count),
            partOf = length(unique(organ)))  %>%
      mutate(id_lab = cell_id,
             type = "Cell type",
             partOf = paste0("Organ(s): ",partOf)) %>% 
      select(tool, id_lab, label, type, partOf, 
             records, cell_count)
    
    # Combine node lists into one list
    #nodes <- rbind(organs, anatomical_structures, cell_types)
    #rm(organs, anatomical_structures, cell_types)
    nodes <- rbind(anatomical_structures, cell_types)
    rm(anatomical_structures, cell_types)
    nodes <- 
      nodes %>% 
      mutate(id = as.numeric(row.names(nodes))-1) %>%
      select(id, id_lab, label, tool, type, partOf, 
             records, cell_count)

    #as_celltypes <- 
    edges <- 
      df_list[[i]] %>% 
      ddply(.(tool, as_id, as, cell_id), summarise,
            weight_recs = length(tool),
            weight_tfidf = median(tfidf)) %>%
      mutate(source_id_lab = paste0(as_id," ",as),
             target_id_lab = cell_id,
             weight = 1) %>% 
      select(source_id_lab, target_id_lab, 
             weight, weight_recs, weight_tfidf) %>%
      distinct()
    
    # Update edge list source and target ids
    edges <- left_join(edges, 
                       nodes[,1:2], by=c("source_id_lab"="id_lab")) %>%
             dplyr::rename(to = id)
    edges <- left_join(edges, 
                       nodes[,1:2], by=c("target_id_lab"="id_lab")) %>%
             dplyr::rename(from = id) %>%
             select(to, from, source_id_lab, target_id_lab,
                    weight, weight_recs, weight_tfidf)
    
    ## Create network from data_frames
    # Select tool name for graph
        tool <- 
      as.character(unique(df_list[[i]]$tool))
    
    ## Save edge and node lists as data files
    write.csv(edges, file=paste0("../network/HRApop_OASCT_",
                                 str_replace(str_to_lower(tool)," ","_"),
                                 "_edgeList.csv"),
              row.names = FALSE)
    write.csv(nodes, file=paste0("../network/HRApop_OASCT_",
                                 str_replace(str_to_lower(tool)," ","_"),
                                 "_nodeList.csv"),
              row.names = FALSE)

    # Combines network edge and node lists
    network <- igraph::graph_from_data_frame(edges, directed=T,
                                  vertices=nodes)
    # Reassigns name of network object with tool names 
    assign(paste0("network_",
                  str_replace(str_to_lower(tool[1])," ","_")),
           network, envir = .GlobalEnv)
    rm(nodes,edges,network, tool)
}

rm(df_list, i)
```
